# Jitsi setup with tokenAuthUrl

This guide is about a Jitsi setup with the following features:

- JWT based authentication on Jitsi
- There is an authentication system which generates tokens for Jitsi
- Each participant (_even guest_) has a token generated by the auth system
- Authentication flow based on `tokenAuthUrl`
- Waiting room for guest and member participants
- Moderator can join directly

## Installation

Assumed that Jitsi will run on Debian 12 VM. It is possible to apply the same
features on different environments.

### Basic Jitsi

Install a basic Jitsi without any customization using
[the official guide](https://jitsi.github.io/handbook/docs/devops-guide/devops-guide-quickstart).

### jitsi-meet-tokens

Install `jitsi-meet-tokens` package:

```bash
apt-get install jitsi-meet-tokens
```

### tokenAuthUrl

Set `tokenAuthUrl` in `config.js`. The link depends on how your authentication
system works:

```javascript
config.tokenAuthUrl = "https://auth.mydomain.com/auth.html?state={state}";
```

### Additional config for jitsi-meet

The following features are also set in `config.js` for our case:

```javascript
// disable the prejoin page to redirect the participant to the authentication
// system immediately if she has no token
config.prejoinConfig = {
  enabled: false,
};

// Enable autoKnock, so the participant will trigger the join attempt
// immediately when she comes to the waiting room
config.lobby = {
  autoKnock: true,
  enableChat: true,
};

// disable the lobby password
config.securityUi = {
  disableLobbyPassword: true,
};
```

### Disable auto ownership

Disable the auto ownership in `Jicofo` to allow `token_affiliation` to manage
the ownership correctly.

```bash
hocon -f /etc/jitsi/jicofo/jicofo.conf set jicofo.conference.enable-auto-owner false
systemctl restart jicofo.service
```

### token_affiliation

This module will control the participant's level in a meeting depending on
`affiliation` fieldd in the token payload.

Install and configure `token_affiliation` module:

```bash
cd /usr/share/jitsi-meet/prosody-plugins/
wget -O mod_token_affiliation.lua https://raw.githubusercontent.com/jitsi-contrib/prosody-plugins/main/token_affiliation/mod_token_affiliation.lua
```

Enable the module in Prosody config:

```lua
Component "conference.meet.mydomain.com" "muc"
  modules_enabled = {
    "token_verification";
    "token_affiliation";
```

See
[token_affiliation](https://github.com/jitsi-contrib/prosody-plugins/tree/main/token_affiliation)
for details.

### muc_wait_for_host

This module is **NOT** used in this setup because it breaks the flow for our
case. It allows everyone to be a moderator if she has a token. So, even guest
participant can join the meeting directly if she has a token.

Therefore this setup implements the waiting room by using the following modules.

### lobby_autostart

This module will start the lobby automatically for each meeting. Only the
participant having a special value in her token payload will bypass this
lobby.

Install and configure `lobby_autostart` module:

```bash
cd /usr/share/jitsi-meet/prosody-plugins/
wget -O mod_lobby_autostart.lua https://raw.githubusercontent.com/jitsi-contrib/prosody-plugins/main/lobby_autostart/mod_lobby_autostart.lua
```

Enable the module in Prosody config:

```lua
Virtualhost "meet.mydomain.com"
  modules_enabled = {
    "muc_lobby_rooms";
    "persistent_lobby";
  }

Component "conference.meet.mydomain.com" "muc"
  modules_enabled = {
    "lobby_autostart";
  }
```

See
[lobby_autostart](https://github.com/jitsi-contrib/prosody-plugins/tree/main/lobby_autostart)
for details.

### token_lobby_bypass

This module allows the participant to bypass the lobby if she has a special
value (`"lobby_bypass" = true`) in her token payload.

Install and configure `token_lobby_bypass` module:

```bash
cd /usr/share/jitsi-meet/prosody-plugins/
wget -O mod_token_lobby_bypass.lua https://raw.githubusercontent.com/jitsi-contrib/prosody-plugins/main/token_lobby_bypass/mod_token_lobby_bypass.lua
```

Enable the module in Prosody config:

```lua
Component "conference.meet.mydomain.com" "muc"
  modules_enabled = {
    "token_lobby_bypass";
  }
```

See
[token_lobby_bypass](https://github.com/jitsi-contrib/prosody-plugins/tree/main/token_lobby_bypass)
for details.

### lobby_deactivate

This module will deactivate the lobby after the first moderator joins the
meeting. So, the participants in the waiting room will join the meeting after
this stage without doing anything.

If the moderator has `context.room.lobby = true` in her token payload, the lobby
will be keeped even this module is enabled.

Install and configure `lobby_deactivate` module:

```bash
cd /usr/share/jitsi-meet/prosody-plugins/
wget -O mod_lobby_deactivate.lua https://raw.githubusercontent.com/jitsi-contrib/prosody-plugins/main/lobby_deactivate/mod_lobby_deactivate.lua
```

Enable the module in Prosody config:

```lua
Component "conference.meet.mydomain.com" "muc"
  modules_enabled = {
    "lobby_deactivate";
  }
```

See
[lobby_deactivate](https://github.com/jitsi-contrib/prosody-plugins/tree/main/lobby_deactivate)
for details.

### Restart services

```bash
systemctl restart prosody.service
systemctl restart jicofo.service
```
